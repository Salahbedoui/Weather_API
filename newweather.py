import pandas as pd
import streamlit as st
from datetime import datetime
from transformers import AutoTokenizer, AutoModelForQuestionAnswering
import torch
from gtts import gTTS
import io

# Function to get weather log from CSV
def get_weather_log():
    try:
        df = pd.read_csv('weather_log.csv', header=None, names=['Timestamp', 'Weather', 'Description', 'Temperature', 'Advice'])
        if df.empty:
            st.write("ุณุฌู ุงูุทูุณ ูุงุฑุบ.")
        return df
    except FileNotFoundError:
        st.error("ููู ุณุฌู ุงูุทูุณ 'weather_log.csv' ุบูุฑ ููุฌูุฏ.")
        return pd.DataFrame()

# Function to generate farming advice based on the weather condition and the month
def give_farming_advice(weather_main, current_month):
    crop_recommendations = {
        1: {"Clear": ["ุซูู", "ุจุตู", "ูุงุตูููุง ุนุฑูุถุฉ"], "Rain": ["ุจุงุฒูุงุก", "ุณุจุงูุฎ"], "Thunderstorm": ["ุงูุชุธุฑ ุงูุทูุณ ุงููุงุฏุฆ ูุจู ุงูุฒุฑุงุนุฉ."]},
        2: {"Clear": ["ุฌุฒุฑ", "ูุฌู", "ุฎุณ"], "Rain": ["ุณูู", "ูุงูู"], "Thunderstorm": ["ุชุฌูุจ ุงูุฒุฑุงุนุฉ ุฎูุงู ุงูุนูุงุตู."]},
        3: {"Clear": ["ุทูุงุทู", "ูููู", "ุฎูุงุฑ"], "Rain": ["ุจุทุงุทุง", "ูุฑุงุซ"], "Thunderstorm": ["ุฃููู ุฎุทุท ุงูุฒุฑุงุนุฉ ููุณูุงูุฉ."]},
        4: {"Clear": ["ุจุทูุฎ", "ูุฑุน", "ุฐุฑุฉ"], "Rain": ["ูุงุตูููุง", "ูุฑูุจ"], "Thunderstorm": ["ุชุฃุฌูู ุงูุฒุฑุงุนุฉ ุญุชู ูุนูุฏ ุงูุทูุณ ุงูุฌุงู."]},
        5: {"Clear": ["ุจุงููุฉ", "ุนุจุงุฏ ุงูุดูุณ", "ููุณุง"], "Rain": ["ุจุทุงุทุง ุญููุฉ"], "Thunderstorm": ["ุชู ุงููุดู ุนู ุนุงุตูุฉ. ุงูุชุธุฑ ุงูุฒุฑุงุนุฉ."]},
        6: {"Clear": ["ุจุงุฐูุฌุงู", "ูุงุตูููุง ุฎุถุฑุงุก", "ุฎูุฎ"], "Rain": ["ุทูุงุทู", "ุชูุช"], "Thunderstorm": ["ุงูุชุธุฑ ุชููู ุงูุนุงุตูุฉ ูุจู ุงูุฒุฑุงุนุฉ."]},
        7: {"Clear": ["ูููู ุญุงุฑ", "ููุณุง", "ุจุทูุฎ"], "Rain": ["ูุงุตูููุง", "ุจุงุฐูุฌุงู"], "Thunderstorm": ["ุงูุชุธุฑ ุญุชู ุชูุฏุฃ ุงูุนุงุตูุฉ."]},
        8: {"Clear": ["ูุดูุด", "ุฐุฑุฉ", "ุจุงุฐูุฌุงู"], "Rain": ["ุจุทุงุทุง ุญููุฉ", "ุทูุงุทู"], "Thunderstorm": ["ุชุฌูุจ ุงูุฒุฑุงุนุฉ ุฎูุงู ุงูุนูุงุตู."]},
        9: {"Clear": ["ููุณุง", "ุฎูุงุฑ", "ูุฑุน"], "Rain": ["ุณุจุงูุฎ", "ุฌุฑุฌูุฑ"], "Thunderstorm": ["ุงูุชุธุฑ ุงุณุชูุฑุงุฑ ุงูุทูุณ."]},
        10: {"Clear": ["ุทูุงุทู", "ุจุทุงุทุง", "ูููู"], "Rain": ["ูุฑุงุซ", "ุฌุฒุฑ"], "Thunderstorm": ["ุชุฃุฌูู ุงูุฒุฑุงุนุฉ ุญุชู ูุฏูุก ุงูุทูุณ."]},
        11: {"Clear": ["ูุฑูุจูุท", "ูุฑูุจ", "ุณุจุงูุฎ"], "Rain": ["ูุงุตูููุง", "ุฎุณ"], "Thunderstorm": ["ุงูุชุธุฑ ุงูุทูุณ ุงููุงุฏุฆ ูุจู ุงูุฒุฑุงุนุฉ."]},
        12: {"Clear": ["ุซูู", "ุจุตู", "ูุงุตูููุง ุนุฑูุถุฉ"], "Rain": ["ุณูู", "ุณุจุงูุฎ"], "Thunderstorm": ["ุงูุชุธุฑ ุงูุนุงุตูุฉ ุซู ุงุณุชุฃูู ุงูุฒุฑุงุนุฉ."]},
    }

    recommendations = crop_recommendations.get(current_month, {}).get(weather_main, "ูุง ุชูุฌุฏ ูุตุงุฆุญ ุฎุงุตุฉ ููููู. ุงุณุชูุฑ ูู ูุชุงุจุนุฉ ุงูุทูุณ.")
    if isinstance(recommendations, list):
        return f"โ ููููู ุฒุฑุงุนุฉ: {', '.join(recommendations)}."
    else:
        return f"โ๏ธ {recommendations}"

# Load tokenizer and model safely
@st.cache_resource
def load_model():
    tokenizer = AutoTokenizer.from_pretrained("asafaya/bert-base-arabic")
    model = AutoModelForQuestionAnswering.from_pretrained("asafaya/bert-base-arabic", low_cpu_mem_usage=False, torch_dtype=None)
    return tokenizer, model

tokenizer, model = load_model()

# Function to get an answer from the context
def get_answer(question, context):
    inputs = tokenizer(question, context, add_special_tokens=True, return_tensors="pt")
    with torch.no_grad():
        outputs = model(**inputs)
    answer_start = torch.argmax(outputs.start_logits)
    answer_end = torch.argmax(outputs.end_logits) + 1
    answer_tokens = inputs.input_ids[0][answer_start:answer_end]
    answer = tokenizer.decode(answer_tokens, skip_special_tokens=True)
    return answer

# Expanded agriculture context (Richer answers)
context = """
ุฃูุถู ููุช ูุฒุฑุงุนุฉ ุงูุทูุงุทู ูู ุนูุฏูุง ุชููู ุฏุฑุฌุงุช ุงูุญุฑุงุฑุฉ ูุง ุจูู 18 ุฅูู 24 ุฏุฑุฌุฉ ูุฆููุฉุ ูุนุงุฏุฉู ูู ุฃุดูุฑ ุฃุจุฑูู ููุงูู.
ุฅุฐุง ููุช ูู ููุงุทู ุฐุงุช ููุงุฎ ุฏุงูุฆุ ูููู ุฒุฑุงุนุชูุง ูู ุจุฏุงูุฉ ุงูุฑุจูุน. ูุฌุจ ุชุฌูุจ ุงูุฒุฑุงุนุฉ ุนูุฏูุง ุชููู ุฏุฑุฌุงุช ุงูุญุฑุงุฑุฉ ุฃูู ูู 10 ุฏุฑุฌุงุช ูุฆููุฉุ ูุฃู ุฐูู ูุฏ ูุคุซุฑ ุณูุจุงู ุนูู ููู ุงููุจุงุช.

ุฃุณุจุงุจ ุงุตูุฑุงุฑ ุฃูุฑุงู ุงูุทูุงุทู ุชุดูู ููุต ุงูููุชุฑูุฌูู ูู ุงูุชุฑุจุฉุ ุฒูุงุฏุฉ ุงูุฑูุ ููุต ุงูุถูุกุ ุฃู ุฃูุฑุงุถ ูุทุฑูุฉ. ูู ุงูููู ุฅุฌุฑุงุก ุงุฎุชุจุงุฑ ููุชุฑุจุฉ ูุชุญุฏูุฏ ูุณุชูู ุงูุนูุงุตุฑ ุงูุบุฐุงุฆูุฉ. ูููู ุชุญุณูู ุฎุตูุจุฉ ุงูุชุฑุจุฉ ุจุฅุถุงูุฉ ุงูุณูุงุฏ ุงูุนุถูู ูุงูุฏุจุงู ุจุดูู ุฏูุฑู.

ูุญูุงูุฉ ุงููุญุงุตูู ูู ุงูุฌุฑุงุฏุ ูุฌุจ ุงุณุชุฎุฏุงู ุดุจูุงุช ูุงููุฉ ุฃู ุฑุด ูุจูุฏุงุช ุญูููุฉ ุทุจูุนูุฉ ูุซู ุงูููู. ูู ุงูุฃูุถู ุชุฌูุจ ุงุณุชุฎุฏุงู ุงููุจูุฏุงุช ุงูููููุงุฆูุฉ ูุฏุฑ ุงูุฅููุงู ููุญูุงุธ ุนูู ุงูุจูุฆุฉ ูุงูุชููุน ุงูุจููููุฌู.

ุฃูุถู ุทุฑููุฉ ูุฑู ุงูุทูุงุทู ูู ุงูุฑู ุจุงูุชูููุทุ ุญูุซ ูุณุงุนุฏ ุฐูู ูู ุชูููุฑ ุงููุงุก ูุชูููู ุฎุทุฑ ุงูุฃูุฑุงุถ ุงููุจุงุชูุฉ. ูููุถู ุณูู ุงููุจุงุชุงุช ูู ุงูุตุจุงุญ ุงูุจุงูุฑ ุฃู ูุณุงุกู ูุชูููู ุงูุชุจุฎุฑ ุงููุงุชุฌ ุนู ุงูุญุฑุงุฑุฉ.

ุนูุฏ ุฒุฑุงุนุฉ ุงูุฐุฑุฉุ ูุฌุจ ุงูุชุฃูุฏ ูู ุฃู ุงูุชุฑุจุฉ ุฎุตุจุฉ ูุฌูุฏุฉ ุงูุชูููุฉ ูุน ุฑู ููุชุธูุ ุฎุงุตุฉ ุฃุซูุงุก ูุฑุญูุฉ ุงูุชุฒููุฑ. ูุฌุจ ุฒุฑุงุนุฉ ุงูุฐุฑุฉ ูู ููุงุทู ูุดูุณุฉ ูุชุฃููู ููููุง ุงูุฌูุฏ.

ุฒุฑุงุนุฉ ุงููููู ุชุญุชุงุฌ ุฅูู ุฏุฑุฌุงุช ุญุฑุงุฑุฉ ูุนุชุฏูุฉ ูุชุฑุจุฉ ุฌูุฏุฉ ุงูุตุฑู ูุน ุชูููุฑ ุณูุงุฏ ุบูู ุจุงูุจูุชุงุณููู. ูููู ุฒุฑุงุนุฉ ุงููููู ูู ุดูุฑู ุฃุจุฑูู ููุงูู ูู ุงูููุงุทู ุงููุนุชุฏูุฉ.

ุฃูุถู ููุช ูุฒุฑุงุนุฉ ุงูุฎูุงุฑ ูู ูู ูุงุฑุณ ุฅูู ููููู ุญุณุจ ุงูููุทูุฉ. ููุถู ุฒุฑุงุนุชู ูู ุชุฑุจุฉ ุฌูุฏุฉ ุงูุชุตุฑูู ูุน ุชูุงูุฑ ุงูุถูุก ุงููุงูู.

ูุญูุงูุฉ ุงููุจุงุชุงุช ูู ุงูุฑูุงุญ ุงูุดุฏูุฏุฉุ ูููู ุงุณุชุฎุฏุงู ูุตุฏุงุช ุฑูุงุญ ุทุจูุนูุฉ ูุซู ุงูุฃุดุฌุงุฑ ุฃู ุชุฑููุจ ุญูุงุฌุฒ ุตูุงุนูุฉ.

ุฒุฑุงุนุฉ ุงูุจุทุงุทุง ูู ุงูููุงุฎ ุงูุญุงุฑ ุชุชู ูู ูุจุฑุงูุฑ ุฅูู ูุงุฑุณ ูุชุฌูุจ ุงูุญุฑุงุฑุฉ ุงูุดุฏูุฏุฉ ูู ุงูุตููุ ููุง ูุณุงุนุฏ ุนูู ููู ุฌูุฏ.

ููู ูููู ุชุญุณูู ุฎุตูุจุฉ ุงูุชุฑุจุฉุ ูููู ุชุญุณูู ุฎุตูุจุฉ ุงูุชุฑุจุฉ ุจุฅุถุงูุฉ ุงูุณูุงุฏ ุงูุนุถูู ูุงูุฏุจุงู ุจุงูุชุธุงู. ุฅุถุงูุฉ ุงููููุจูุณุช ูุงูููุงุฏ ุงูุนุถููุฉ ุงูุฃุฎุฑู ูููู ุฃู ูุณุงุนุฏ ูู ุชุญุณูู ุจููุฉ ุงูุชุฑุจุฉ ูุฒูุงุฏุฉ ูุญุชูู ุงููุบุฐูุงุช.

ุฃุณุจุงุจ ุชุณุงูุท ุฃุฒูุงุฑ ุงูุทูุงุทู ูููู ุฃู ุชุดูู ุฏุฑุฌุงุช ุงูุญุฑุงุฑุฉ ุงููุฑุชูุนุฉ ุฃู ุงูุฎูุงุถ ุงูุฑุทูุจุฉุ ุจุงูุฅุถุงูุฉ ุฅูู ููุต ุงูุนูุงุตุฑ ุงูุบุฐุงุฆูุฉ ูุซู ุงูุจูุชุงุณููู ุฃู ุงูููุณููุฑ. ูุฏ ูููู ุฃูุถุงู ูุชูุฌุฉ ูููุต ุงูุชูููุญ.
"""

# UI Start
st.title("ูุณุงุนุฏ ุงูุทูุณ ูุงูุฒุฑุงุนุฉ ๐ฑ๐ฆ๏ธ")

# Weather Section
st.header("ุงุชุฌุงูุงุช ุงูุทูุณ")
df = get_weather_log()
if df.empty:
    st.write("ูุง ุชูุฌุฏ ุจูุงูุงุช ุงูุทูุณ ูุนุฑุถูุง.")
else:
    st.write(df.tail())

    try:
        df['Temperature'] = pd.to_numeric(df['Temperature'], errors='coerce')
    except Exception as e:
        st.error(f"ุฎุทุฃ ูู ุชุญููู ุจูุงูุงุช ุงูุญุฑุงุฑุฉ: {e}")

    if not df['Temperature'].isnull().all():
        st.line_chart(df['Temperature'])
    else:
        st.write("ุจูุงูุงุช ุงูุญุฑุงุฑุฉ ููููุฏุฉ ุฃู ุบูุฑ ุตุญูุญุฉ.")

    latest_weather = df.iloc[-1]['Weather']
    current_month = datetime.now().month
    current_advice = give_farming_advice(latest_weather, current_month)

    st.header("ุงููุตูุญุฉ ุงูุฒุฑุงุนูุฉ ุงูุญุงููุฉ")
    st.success(current_advice)

# Question Answering Section
st.header("ุงูุฅุฌุงุจุฉ ุนูู ุงูุฃุณุฆูุฉ ุงูุฒุฑุงุนูุฉ")
st.write("ุงุณุฃู ุณุคุงูุงู ุนู ุงูุฒุฑุงุนุฉุ ูุณููุฏู ูู ุฅุฌุงุจุฉ ูุน ุฅููุงููุฉ ุงูุงุณุชูุงุน ููุง.")

user_question = st.text_input("๐ ุงูุชุจ ุณุคุงูู ููุง:")

if user_question:
    answer = get_answer(user_question, context)
    if answer.strip():
        st.info(f"ุงูุฅุฌุงุจุฉ: {answer}")
        audio_option = st.radio("๐ง ูู ุชุฑุบุจ ูู ุณูุงุน ุงูุฅุฌุงุจุฉุ", ("ูุนู", "ูุง"))
        if audio_option == "ูุนู":
            tts = gTTS(answer, lang='ar')
            audio_buffer = io.BytesIO()
            tts.write_to_fp(audio_buffer)
            audio_buffer.seek(0)
            st.audio(audio_buffer, format="audio/mp3")
    else:
        st.warning("โ ูู ูุชู ุงูุนุซูุฑ ุนูู ุฅุฌุงุจุฉ ุฏูููุฉ. ุญุงูู ุทุฑุญ ุณุคุงู ุขุฎุฑ.")
